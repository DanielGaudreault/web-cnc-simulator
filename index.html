<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCNC Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">WebCNC Simulator</div>
            <div class="header-controls">
                <select id="templateSelector" onchange="loadTemplate(this.value)">
                    <option value="">Select Template...</option>
                    <option value="basic_grid">Basic Grid</option>
                    <option value="pocketing">Pocketing Operations</option>
                    <option value="contouring">Contouring</option>
                    <option value="drilling">Drilling Pattern</option>
                    <option value="engraving">Engraving</option>
                    <option value="3d_surface">3D Surface</option>
                </select>
                <button onclick="loadGCodeExample('square')">Square</button>
                <button onclick="loadGCodeExample('circle')">Circle</button>
                <button onclick="loadGCodeExample('grid')">Grid</button>
                <button onclick="loadGCodeExample('spiral')">Spiral</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="control-group">
                <div class="control-label">Workpiece Setup</div>
                <input type="number" id="workpieceWidth" placeholder="Width (mm)" value="100">
                <input type="number" id="workpieceHeight" placeholder="Height (mm)" value="100">
                <input type="number" id="workpieceDepth" placeholder="Depth (mm)" value="20">
                <button onclick="createWorkpiece()">Create Workpiece</button>
            </div>

            <div class="control-group">
                <div class="control-label">Tool Setup</div>
                <select id="toolType">
                    <option value="endmill">End Mill (6mm)</option>
                    <option value="ballnose">Ball Nose (8mm)</option>
                    <option value="drill">Drill (4mm)</option>
                    <option value="v-bit">V-Bit (90°)</option>
                    <option value="facemill">Face Mill</option>
                </select>
                <input type="number" id="toolDiameter" placeholder="Tool Diameter (mm)" value="6">
                <input type="number" id="feedRate" placeholder="Feed Rate (mm/min)" value="1000">
                <input type="number" id="spindleSpeed" placeholder="Spindle Speed (RPM)" value="10000">
            </div>

            <div class="control-group">
                <div class="control-label">Simulation Controls</div>
                <div class="control-buttons">
                    <button onclick="startSimulation()" class="play-btn">▶ Play</button>
                    <button onclick="pauseSimulation()" class="pause-btn">⏸ Pause</button>
                    <button onclick="resetSimulation()" class="stop-btn">⏹ Stop</button>
                </div>
                <input type="range" id="simulationSpeed" min="1" max="10" value="5">
                <div class="control-label">Speed: <span id="speedValue">5</span>x</div>
            </div>

            <div class="control-group">
                <div class="control-label">View Controls</div>
                <div class="control-buttons">
                    <button onclick="toggleToolpath()">Toggle Toolpath</button>
                    <button onclick="toggleWorkpiece()">Toggle Workpiece</button>
                    <button onclick="toggleGrid()">Toggle Grid</button>
                    <button onclick="resetView()">Reset View</button>
                </div>
                <div class="view-presets">
                    <button onclick="setView('top')">Top</button>
                    <button onclick="setView('front')">Front</button>
                    <button onclick="setView('side')">Side</button>
                    <button onclick="setView('iso')">Isometric</button>
                </div>
            </div>
        </div>

        <div class="viewer">
            <canvas id="viewport"></canvas>
            <div class="coordinates" id="coordinates">X: 0.00 Y: 0.00 Z: 0.00</div>
            <div class="simulation-info" id="simulationInfo">Ready</div>
            
            <!-- 3D Axes Controller -->
            <div class="axes-controller" id="axesController">
                <div class="axes-label">View Controls</div>
                <canvas id="axesViewport"></canvas>
                <div class="axes-instructions">
                    Drag to rotate view<br>
                    Scroll to zoom
                </div>
            </div>

            <!-- Grid Controls -->
            <div class="grid-controls">
                <div class="control-label">Grid Settings</div>
                <input type="number" id="gridSize" value="100" min="10" max="500" onchange="updateGrid()">
                <input type="number" id="gridDivisions" value="10" min="5" max="50" onchange="updateGrid()">
                <button onclick="toggleGrid()">Toggle Grid</button>
            </div>
        </div>

        <div class="tools-panel">
            <div class="control-group">
                <div class="control-label">Simulation Stats</div>
                <div id="stats">
                    <div>Time: <span id="simTime">0:00</span></div>
                    <div>Operations: <span id="opCount">0</span></div>
                    <div>Material Removed: <span id="materialRemoved">0%</span></div>
                    <div>Tool Position: <span id="toolPos">X0 Y0 Z0</span></div>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Current Operation</div>
                <div id="currentOp">None</div>
            </div>

            <div class="control-group">
                <div class="control-label">Machine State</div>
                <div id="machineState">
                    <div>Units: MM</div>
                    <div>Mode: Absolute</div>
                    <div>Plane: XY</div>
                    <div>Feed: 1000 mm/min</div>
                </div>
            </div>

            <div class="control-group">
                <div class="control-label">Quick Templates</div>
                <div class="template-buttons">
                    <button onclick="loadTemplate('basic_grid')">Basic Grid</button>
                    <button onclick="loadTemplate('pocketing')">Pocketing</button>
                    <button onclick="loadTemplate('contouring')">Contouring</button>
                    <button onclick="loadTemplate('drilling')">Drilling</button>
                </div>
            </div>
        </div>

        <div class="gcode-panel">
            <div class="panel-header">
                G-code Editor
                <div class="editor-controls">
                    <button onclick="formatGCode()">Format</button>
                    <button onclick="clearGCode()">Clear</button>
                    <button onclick="validateGCode()">Validate</button>
                    <button onclick="exportGCode()">Export</button>
                </div>
            </div>
            <textarea class="gcode-editor" id="gcodeEditor" spellcheck="false" placeholder="Enter your G-code here..."></textarea>
        </div>
    </div>

    <!-- Load Three.js from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="gcode-examples.js"></script>
    <script src="templates.js"></script>
    <script src="simulator.js"></script>
    
    <script>
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', () => {
            // Load default template
            setTimeout(() => {
                loadTemplate('basic_grid');
                if (typeof THREE !== 'undefined' && !simulator) {
                    simulator = new CNCSimulator();
                    createWorkpiece();
                }
            }, 100);
        });

        function setView(viewType) {
            if (!simulator) return;
            
            switch(viewType) {
                case 'top':
                    simulator.camera.position.set(0, 200, 0);
                    simulator.camera.lookAt(0, 0, 0);
                    simulator.camera.up.set(0, 0, -1);
                    break;
                case 'front':
                    simulator.camera.position.set(0, 0, 200);
                    simulator.camera.lookAt(0, 0, 0);
                    simulator.camera.up.set(0, 1, 0);
                    break;
                case 'side':
                    simulator.camera.position.set(200, 0, 0);
                    simulator.camera.lookAt(0, 0, 0);
                    simulator.camera.up.set(0, 1, 0);
                    break;
                case 'iso':
                    simulator.camera.position.set(150, 150, 150);
                    simulator.camera.lookAt(0, 0, 0);
                    simulator.camera.up.set(0, 1, 0);
                    break;
            }
            simulator.updateCameraPyramid();
        }

        function toggleGrid() {
            if (simulator) {
                simulator.toggleGrid();
            }
        }

        function updateGrid() {
            if (simulator) {
                const size = parseInt(document.getElementById('gridSize').value) || 100;
                const divisions = parseInt(document.getElementById('gridDivisions').value) || 10;
                simulator.updateGrid(size, divisions);
            }
        }

        function exportGCode() {
            const gcode = document.getElementById('gcodeEditor').value;
            const blob = new Blob([gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cnc_program.nc';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
